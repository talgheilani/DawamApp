@model IEnumerable<DawamApp.Models.EmployeeStatus>

@{
    ViewData["Title"] = "Admin Calendar - DawamApp";
    var email = Context.Session.GetString("Email"); // get logged-in email
    bool isAdmin = email == "tasnim.k.algheilani@mem.gov.om"; // check admin
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<style>
    .sidebar { width:200px; border-right:1px solid #ddd; padding:20px; border-radius:5px; background-color:#3466bc29; }
    .fc-day-sat, .fc-day-fri { background-color: #f8f9fa; }
    .fc .fc-button { background-color:#224587; border-color:#224587; color:#fff; font-weight:500; }
    .fc .fc-button:hover, .fc .fc-button:focus, .fc .fc-button:active { background-color:#1b356e; border-color:#1b356e; color:#fff; }
    .fc .fc-button-primary:not(:disabled).fc-button-active { background-color:#1b356e; border-color:#1b356e; color:#fff; }
    .header-bar { background-color:#3466bc29; padding:10px 15px; border-radius:5px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; }
</style>

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-md-2 sidebar">
            <h5>Filters</h5>
            <div class="mb-2"><input type="checkbox" id="all" checked><label for="all">All</label></div>
            <div class="mb-2"><input type="checkbox" class="status-filter" value="Training" checked><label>Training (تدريب)</label></div>
            <div class="mb-2"><input type="checkbox" class="status-filter" value="Discharge" checked><label>Discharge (إعفاء)</label></div>
            <div class="mb-2"><input type="checkbox" class="status-filter" value="Holiday" checked><label>Holiday (إجازة)</label></div>
            <div class="mb-2"><input type="checkbox" class="status-filter" value="Duty" checked><label>Duty (مهمة)</label></div>
            <div class="mb-2"><input type="checkbox" class="status-filter" value="Workshop" checked><label>Workshop (ورشة)</label></div>
        </div>

        <!-- Calendar -->
        <div class="col-md-10">

            <!-- Admin access message -->
@if (isAdmin)
{
    <div class="access-message" id="adminMessage" style="position: relative; padding: 10px; background-color: #d4edda; color: #155724; border: 1px solid #bee5eb; border-radius: 5px;">
        Access Granted. Welcome Admin!
        <span id="closeAdminMessage" style="position: absolute; top: 5px; right: 10px; cursor: pointer; font-weight: bold;">&times;</span>
    </div>

    <script>
        document.getElementById('closeAdminMessage').onclick = function() {
            var msg = document.getElementById('adminMessage');
            msg.style.display = 'none';
        }
    </script>
}


            <!-- Header bar with conditional Edit button -->
            <div class="header-bar">
                <h2 class="mb-0">Dashboard</h2>

                @if(isAdmin)
                {
                    <a href="/User/Edit" class="btn btn-primary" style="background-color:#224587; border-color:#224587; border-radius:0;">
                        <i class="bi bi-pencil-square"></i> Edit Statuses
                    </a>
                }
            </div>

            <!-- Calendar container -->
            <div id="calendar"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridWeek,dayGridMonth,multiMonthYear' },
        views: { multiMonthYear: { type:'dayGridMonth', duration:{ months:12 }, buttonText:'Year' } },
        events: function(fetchInfo, successCallback, failureCallback) {
            var filters = [];
            document.querySelectorAll('.status-filter:checked').forEach(cb => filters.push(cb.value));
            fetch('/Admin/GetEvents?statuses=' + filters.join(','))
                .then(res => res.json())
                .then(data => {
                    @* If not admin, filter events by logged-in user *@
                    var isAdmin = "@isAdmin" === "True";
                    if(!isAdmin){
                        var userName = "@(Context.Session.GetString("FirstName") + " " + Context.Session.GetString("LastName"))";
                        data = data.filter(e => e.title.startsWith(userName));
                    }
                    successCallback(data);
                })
                .catch(err => failureCallback(err));
        }
    });

    calendar.render();

    // Filters
    document.querySelectorAll('.status-filter').forEach(cb => {
        cb.addEventListener('change', function () { calendar.refetchEvents(); 
            document.getElementById('all').checked =
                document.querySelectorAll('.status-filter:checked').length ===
                document.querySelectorAll('.status-filter').length;
        });
    });

    document.getElementById('all').addEventListener('change', function() {
        var checked = this.checked;
        document.querySelectorAll('.status-filter').forEach(cb => cb.checked = checked);
        calendar.refetchEvents();
    });
});
</script>
